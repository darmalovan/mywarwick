@import models.publishing.PermissionScope
@(
    form: Form[_],
    fieldName: String,
    departmentOptions: Seq[(String, String)],
    itemName: String,
    permissionScope: PermissionScope,
    allowPublic: Boolean
)(implicit fc: b3.B3FieldConstructor, messages: Messages)
@defining((s"$fieldName.audience", s"$fieldName.department")) { case (audienceField, departmentField) =>

    @* TODO make less of a UI nightmare *@
    @* TODO receive list of allowed audiences from controller - each user's will be different *@
    @b3.multifieldFormGroup(
      Seq(form(fieldName), form(audienceField), form(departmentField)),
      Seq('_label -> s"Who is this $itemName for?", 'id -> "item_audience"),
      Nil) { info =>

      <div class="audience-picker">

        @for((msg, i) <- info.errorsAndInfos.zipWithIndex) { <span class="help-block" id="item_audience_error_@i">@msg</span> }

        @if(permissionScope == PermissionScope.AllDepartments) {
          @if(allowPublic) {
            @tags.seqCheckbox(form, audienceField, 'id -> "public", '_text -> "Everyone (public)", 'value -> "Public")
          }

          @tags.seqCheckbox(form, audienceField, 'id -> "staff", '_text -> "All staff", 'value -> "Staff")
          @tags.seqCheckbox(form, audienceField, 'id -> "teaching", '_text -> "Teaching staff", 'value -> "TeachingStaff")
          @tags.seqCheckbox(form, audienceField, 'id -> "ug", '_text -> "Undergraduates", 'value -> "UndergradStudents")
          @tags.seqCheckbox(form, audienceField, 'id -> "pgt", '_text -> "PG Taught", 'value -> "TaughtPostgrads")
          @tags.seqCheckbox(form, audienceField, 'id -> "pgr", '_text -> "PG Research", 'value -> "ResearchPostgrads")
        }

        @if(departmentOptions.size == 1) {
          @b3.static(){ @departmentOptions.head._2 }(b3.clear.fieldConstructorSpecific)
          @b3.hidden(departmentField, departmentOptions.head._1)
        } else {
          @b3.select(form(departmentField), departmentOptions,
            '_text -> "Department",
            '_default -> "",
            Symbol("data-select") -> "department"
          )(b3.clear.fieldConstructorSpecific, messages)
        }

        <div class=row>
          <div class="col-xs-11 col-xs-offset-1">
            @tags.seqCheckbox(form, audienceField, 'id -> "dept-all", '_text -> "Everyone", 'value -> "Dept:All")
            @tags.seqCheckbox(form, audienceField, 'id -> "dept-staff", '_text -> "All staff", 'value -> "Dept:Staff")
            @tags.seqCheckbox(form, audienceField, 'id -> "dept-teaching", '_text -> "Teaching staff", 'value -> "Dept:TeachingStaff")
            @tags.seqCheckbox(form, audienceField, 'id -> "dept-ug", '_text -> "Undergraduates", 'value -> "Dept:UndergradStudents")
            @tags.seqCheckbox(form, audienceField, 'id -> "dept-pgt", '_text -> "PG Taught", 'value -> "Dept:TaughtPostgrads")
            @tags.seqCheckbox(form, audienceField, 'id -> "dept-pgr", '_text -> "PG Research", 'value -> "Dept:ResearchPostgrads")
          </div>
        </div>

      </div>
    }
}
