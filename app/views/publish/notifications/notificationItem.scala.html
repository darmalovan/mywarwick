@import models.publishing.Publisher
@import publishing.Role
@import models.publishing.Ability.EditNotifications
@import models.publishing.Ability.DeleteNotifications
@import system.RequestContext
@import services.dao.DepartmentInfo
@(
    publisher: Publisher,
    item: ActivityRenderWithAudience,
    user: Role,
    allDepartments: Seq[DepartmentInfo]
)(implicit context: RequestContext)

<div class="activity-item row" data-activity-id="@item.activity.id">
  <div class="media">
    <div class="col-xs-10">
      <div class="media-left">
        <i class="app-icon app-icon--lg fa fa-fw fa-@item.icon.map(_.name).getOrElse("newspaper-o")"
        data-background-color="@item.icon.map(_.colour).getOrElse("#5b3069")">
        </i>
      </div>
      <div class="media-body">
        <div class="activity-item__title">@item.activity.title</div>
        @item.activity.text.map { text =>
          <div class="activity-item__text">@text</div>
        }
        <div class="activity-item__audience">
          @item.audienceSize match {
            case AudienceSize.Public => {
              <span>To: public</span>
            }
            case AudienceSize.Finite(c) => {
              <span>
              To: @c
                @if(c == 1) { recipient } else { recipients }
                @if(item.audienceComponents.nonEmpty) {
                  <i class="activity-item__audience-details fa collapsed" data-toggle="collapse" data-target="#@item.activity.id" data-is-sent="@item.isSent"></i>
                  <div id="@item.activity.id" class="collapse">
                    <div><strong>Audience</strong></div>
                    <div style="margin-left: 15px;">@tags.audienceComponents(item.audienceComponents, allDepartments)</div>
                    <div><strong>Sent details</strong></div>
                    <div style="margin-left: 15px;">
                      <div class="activity-item__sent-details" style="display: none">
                        <div class="activity-item__sent-details-read-count">
                          Read: <i class="fa fa-spin fa-refresh"></i></div>
                        <div class="activity-item__sent-details-failed">
                          Failed: <i class="fa fa-spin fa-refresh"></i></div>
                        <div class="activity-item__sent-details-skipped">
                          Skipped: <i class="fa fa-spin fa-refresh"></i></div>
                      </div>
                    </div>
                  </div>
                }
              </span>
            }
            case _ => {}
          }
        </div>
        @if(item.isSendingNow) {
        <div class="activity-item__audience activity-item__send-progress">
          <i class="fa fa-spin fa-refresh"></i>
          Processed
          <span class="activity-item__sent-count">
            @("%,d".format(item.sentCount))
          </span>
          @item.audienceSize match {
            case AudienceSize.Finite(size) => {
              of @("%,d".format(size))
            }
            case _ => {}
          }
          recipients
        </div>
        }
        <div class="activity-item__date">
          @models.DateFormats.emailDateTime(item.activity.publishedAt)
          by
          @item.createdBy.name.full.getOrElse("[Unknown]") (@item.createdBy.usercode.string)
        </div>
        @item.activity.url.map { url =>
          <div class="activity-item__visible-link">
            Link to  <a href="@url">@url</a>
          </div>
        }
      </div>
    </div>
    <div class="col-xs-2">
      @if(item.activity.publishedAt.isAfterNow) {
        <div class="btn-toolbar pull-right">
        @if(user can EditNotifications) {
            <a href="@controllers.publish.routes.NotificationsController.updateForm(publisher.id, item.activity.id)" class="btn btn-default">
              Edit</a>
          }
        @if(user can DeleteNotifications) {
          <a href=""
          class="btn btn-danger delete"
          >Delete</a>
      </div>
      <div class="btn-toolbar pull-right confirm-delete">
        <p>Are you sure?</p>
        @helper.form(controllers.publish.routes.NotificationsController.delete(publisher.id, item.activity.id)) {
          @context.csrfHelper.formField
          <button type="submit" class="btn btn-danger">Delete</button>
        }
        <button class="btn btn-default cancel">Cancel</button>
      </div>
      } else { </div> }
    }
    </div>
  </div>
</div>
